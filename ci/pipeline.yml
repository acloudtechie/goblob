groups: []

resource_types:
- name: gcs-resource
  type: docker-image
  source:
    repository: frodenas/gcs-resource

- name: pivnet
  type: docker-image
  source:
    repository: pivotalcf/pivnet-resource
    tag: latest-final

resources:
- name: goblob
  type: git
  source:
    branch: master
    private_key: {{git-private-key}}
    uri: git@github.com:pivotalservices/goblob.git
    ignore_paths:
    - ci

- name: pivnet-release
  type: pivnet
  source:
    api_token: {{pivnet-api-token}}
    product_slug: goblob
    access_key_id: {{pivnet-aws-access-key}}
    secret_access_key: {{pivnet-aws-secret-key}}

- name: goblob-github-rc
  type: github-release
  source:
    release: false
    pre_release: true
    user: pivotalservices
    repository: goblob
    access_token: {{github-access-token}}

- name: goblob-gh-release
  type: github-release
  source:
    user: pivotalservices
    repository: goblob
    access_token: {{github-access-token}}

- name: version
  type: semver
  source:
    driver: git
    uri: git@github.com:pivotalservices/goblob.git
    branch: version
    file: version
    private_key: {{git-private-key}}

jobs:
- name: create-rc
  serial_groups: [version]
  plan:
  - aggregate:
    - get: goblob
      trigger: true
    - get: version
      params: {pre: rc}
  - task: install-dependencies
    file: goblob/ci/install-dependencies.yml
  - aggregate:
    - task: unit
      file: goblob/ci/unit.yml
      params:
        MINIO_ACCESS_KEY: example-access-key
        MINIO_SECRET_KEY: example-secret-key
    - task: build-linux
      file: goblob/ci/build-linux.yml
    - task: build-darwin
      file: goblob/ci/build-darwin.yml
    - task: build-windows
      file: goblob/ci/build-windows.yml
  - aggregate:
    - put: version
      params: {pre: rc}
    - do:
      - task: create-release-notes
        file: goblob/ci/create-release-notes.yml
      - put: goblob-github-rc
        params:
          name: release-notes/name
          tag: release-notes/tag
          globs:
          - linux-binary/*
          - darwin-binary/*
          - windows-binary/*

- name: shipit
  serial_groups: [version]
  plan:
  - aggregate:
    - get: goblob-github-rc
      passed: [create-rc]
    - get: version
      params: {bump: final}
    - get: goblob
      passed: [create-rc]
  - put: goblob
    params:
      repository: goblob
      only_tag: true
      tag: version/version
      tag_prefix: v
  - aggregate:
    - do:
      - task: create-pivnet-metadata
        file: goblob/ci/create-pivnet-metadata.yml
      - put: pivnet-release
        params:
          metadata_file: pivnet-metadata/metadata.yml
          file_glob: goblob-github-rc/goblob*
          s3_filepath_prefix: {{pivnet-filepath-prefix}}
    - do:
      - task: create-release-notes
        file: goblob/ci/create-release-notes.yml
      - put: goblob-gh-release
        params:
          name: release-notes/name
          tag: release-notes/tag
          globs:
          - goblob-github-rc/*
    - put: version
      params:
        bump: minor
        pre: rc
